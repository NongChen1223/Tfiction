# Tfiction - 业务功能文档

本文档详细说明 Tfiction 小说阅读器的所有业务功能、实现逻辑和未来规划。

## 目录

- [核心功能](#核心功能)
- [详细功能说明](#详细功能说明)
- [业务流程](#业务流程)
- [数据存储](#数据存储)
- [未来规划](#未来规划)

---

## 核心功能

### 1. 小说文件管理

#### 1.1 文件导入
- **支持格式**
  - ✅ TXT（纯文本）
  - 🔄 EPUB（电子出版物）
  - 🔄 PDF（便携式文档）
  - 🔄 MOBI（Kindle格式）
  - 🔄 AZW3（Kindle新格式）

- **导入方式**
  - 文件选择对话框
  - 拖拽文件到窗口
  - 双击文件关联打开

- **文件限制**
  - 最大文件大小：100MB（可配置）
  - 自动编码检测（UTF-8、GBK、GB2312等）

#### 1.2 文件解析
- **TXT 解析**
  - 自动识别章节（正则匹配：第X章、Chapter X等）
  - 提取章节标题和内容
  - 计算章节字数
  - 生成目录结构

- **EPUB 解析**（规划中）
  - 解压 EPUB 文件
  - 解析 OPF 目录文件
  - 提取 HTML 章节内容
  - 支持图片显示

- **PDF 解析**（规划中）
  - 提取文本内容
  - 识别页码和章节
  - 保留排版格式

#### 1.3 格式转换
- **转换方向**（规划中）
  - TXT ↔ EPUB
  - TXT → PDF
  - EPUB → TXT

- **转换选项**
  - 保留章节结构
  - 自定义字体和样式
  - 生成目录

### 2. 阅读体验

#### 2.1 阅读界面
- **布局组件**
  - 顶部工具栏（文件操作、设置）
  - 左侧侧边栏（章节目录）
  - 中间阅读区域（小说内容）
  - 右侧搜索面板（关键字搜索）

- **阅读模式**
  - 单页模式（连续滚动）
  - 分页模式（翻页效果）【规划中】
  - 自动滚动模式【规划中】

#### 2.2 主题和样式
- **预设主题**
  - 亮色主题（白底黑字）
  - 暗色主题（黑底白字）
  - 护眼主题（米黄底深棕字）

- **自定义设置**
  - 字体大小（12-32px，默认16px）
  - 字体类型（系统字体、宋体、黑体等）
  - 行高（1.0-3.0，默认1.8）
  - 背景颜色（自定义颜色选择器）
  - 文字颜色（自定义颜色选择器）
  - 页面宽度（600-1200px，默认800px）

#### 2.3 阅读进度
- **自动保存**
  - 实时保存当前章节
  - 保存阅读位置（字符偏移量）
  - 保存阅读进度百分比
  - 记录最后阅读时间

- **进度同步**
  - 本地持久化存储
  - 跨会话恢复进度
  - 最近阅读列表

#### 2.4 章节导航
- **目录导航**
  - 章节列表显示
  - 点击跳转到指定章节
  - 当前章节高亮显示
  - 章节搜索功能【规划中】

- **快捷导航**
  - 上一章/下一章按钮
  - 快捷键支持（方向键、PageUp/PageDown）
  - 滚动条拖动

### 3. 搜索功能

#### 3.1 全文搜索
- **搜索方式**
  - 关键字搜索
  - 区分/不区分大小写
  - 正则表达式搜索【规划中】

- **搜索结果**
  - 显示匹配数量
  - 显示上下文预览（前后各50字符）
  - 显示行号
  - 点击跳转到对应位置

- **高亮显示**
  - 搜索关键字高亮
  - 自定义高亮颜色
  - 多关键字同时高亮【规划中】

#### 3.2 章节内搜索
- **功能特性**
  - 限定当前章节搜索
  - 快速定位
  - 结果导航（上一个/下一个）

### 4. 摸鱼模式（核心特色功能）

#### 4.1 窗口置顶
- **置顶功能**
  - 一键开启/关闭窗口置顶
  - 窗口始终显示在最前面
  - 不影响其他窗口操作

#### 4.2 背景透明
- **透明度控制**
  - 透明度范围：0-100%
  - 滑动条调节
  - 快捷键调节（Ctrl + +/-）

- **透明效果**
  - 背景模糊（毛玻璃效果）
  - 文字清晰可读
  - 自适应不同背景

#### 4.3 鼠标悬停显示/隐藏
- **悬停显示**
  - 鼠标进入窗口区域：内容完全显示
  - 鼠标离开窗口区域：内容淡出隐藏
  - 过渡动画（0.3秒淡入淡出）

- **触发条件**
  - 仅在摸鱼模式开启时生效
  - 支持自定义显示/隐藏延迟【规划中】

#### 4.4 快速切换
- **操作方式**
  - 工具栏按钮一键切换
  - 全局快捷键（Ctrl + Shift + S）
  - 系统托盘菜单切换

- **状态指示**
  - 工具栏按钮高亮
  - 系统托盘图标变化【规划中】

### 5. 窗口管理

#### 5.1 窗口控制
- **基础操作**
  - 最小化
  - 最大化/恢复
  - 全屏模式
  - 关闭

- **窗口尺寸**
  - 自由调整大小
  - 记忆窗口位置和大小
  - 多显示器支持

#### 5.2 窗口特效
- **透明度**
  - 全局透明度调节
  - 摸鱼模式透明度（默认30%）
  - 正常模式透明度（100%）

- **动画效果**
  - 窗口淡入淡出
  - 内容平滑过渡
  - 按钮悬停效果

### 6. 书签和标注（规划中）

#### 6.1 书签功能
- **添加书签**
  - 右键菜单添加书签
  - 快捷键添加（Ctrl + D）
  - 书签备注

- **书签管理**
  - 书签列表显示
  - 书签跳转
  - 书签编辑/删除

#### 6.2 文本标注
- **划线标注**
  - 选中文本添加下划线
  - 自定义标注颜色
  - 标注备注

- **笔记功能**
  - 为段落添加笔记
  - 笔记列表查看
  - 笔记导出

### 7. 导出功能（规划中）

#### 7.1 内容导出
- **导出格式**
  - 导出为 TXT
  - 导出为 PDF
  - 导出为 EPUB

- **导出选项**
  - 导出全文
  - 导出选定章节
  - 导出选定文本

#### 7.2 笔记导出
- **导出方式**
  - 导出书签和标注
  - 导出阅读笔记
  - 导出为 Markdown

---

## 详细功能说明

### 小说解析逻辑

#### TXT 章节识别算法

```
1. 读取 TXT 文件内容
2. 按行分割文本
3. 遍历每一行，使用正则表达式匹配章节标题：
   - 匹配模式1：^第[0-9零一二三四五六七八九十百千]+[章节回]
   - 匹配模式2：^Chapter\s+\d+
   - 匹配模式3：^\d+\.\s+
4. 识别到章节标题时：
   - 保存上一章节的结束位置
   - 创建新章节对象
   - 记录章节标题、起始位置、索引
5. 文件结束时保存最后一章的结束位置
6. 返回章节列表
```

#### 章节内容提取

```
根据章节的 startPos 和 endPos 从原始内容中截取对应片段
```

### 摸鱼模式实现逻辑

#### 前端实现

```typescript
// 1. 监听鼠标进入/离开事件
useEffect(() => {
  const handleMouseEnter = () => {
    if (isStealthMode) {
      // 显示内容
      setContentVisible(true)
    }
  }

  const handleMouseLeave = () => {
    if (isStealthMode) {
      // 隐藏内容
      setContentVisible(false)
    }
  }

  window.addEventListener('mouseenter', handleMouseEnter)
  window.addEventListener('mouseleave', handleMouseLeave)

  return () => {
    window.removeEventListener('mouseenter', handleMouseEnter)
    window.removeEventListener('mouseleave', handleMouseLeave)
  }
}, [isStealthMode])

// 2. CSS 动画控制显示/隐藏
.content {
  opacity: 1;
  transition: opacity 0.3s ease-in-out;
}

.content.hidden {
  opacity: 0;
  pointer-events: none;
}
```

#### 后端实现

```go
// 1. 设置窗口置顶
runtime.WindowSetAlwaysOnTop(ctx, true)

// 2. 发送透明度事件到前端
runtime.EventsEmit(ctx, "window:opacity", 0.3)

// 3. 监听鼠标事件
runtime.EventsOn(ctx, "window:mouseEnter", handleMouseEnter)
runtime.EventsOn(ctx, "window:mouseLeave", handleMouseLeave)
```

### 搜索实现逻辑

#### 全文搜索算法

```
1. 获取小说全文内容
2. 根据区分大小写选项，转换搜索字符串和内容
3. 使用 strings.Index() 循环查找关键字位置
4. 对每个匹配位置：
   - 记录位置索引
   - 提取上下文（前后各50字符）
   - 计算行号
   - 创建搜索结果对象
5. 返回搜索结果列表
```

#### 搜索结果高亮

```typescript
// 使用正则表达式替换关键字为高亮标签
const highlightedContent = content.replace(
  new RegExp(keyword, 'gi'),
  '<mark>$&</mark>'
)
```

### 阅读进度保存

#### 数据结构

```go
type ReadingProgress struct {
  FilePath       string  // 文件路径
  CurrentChapter int     // 当前章节索引
  Position       int     // 当前阅读位置（字符偏移）
  Progress       float64 // 阅读进度百分比
  LastReadTime   int64   // 最后阅读时间戳
}
```

#### 保存策略

- 每隔10秒自动保存一次
- 切换章节时立即保存
- 关闭小说时保存
- 退出应用时保存所有未保存的进度

#### 存储位置

```
用户主目录/.tfiction/progress.json
```

---

## 业务流程

### 1. 打开小说流程

```
用户点击"打开文件"
    ↓
调用系统文件选择对话框
    ↓
用户选择小说文件
    ↓
后端接收文件路径
    ↓
检查文件格式是否支持
    ↓
读取文件内容（编码自动检测）
    ↓
解析章节结构
    ↓
创建 Novel 对象
    ↓
缓存小说数据
    ↓
返回小说信息给前端
    ↓
前端更新 store 状态
    ↓
渲染阅读界面
    ↓
检查是否有保存的阅读进度
    ↓
如有进度，自动跳转到上次位置
```

### 2. 摸鱼模式切换流程

```
用户点击"摸鱼模式"按钮
    ↓
前端调用 windowService.ToggleStealthMode()
    ↓
后端判断当前状态
    ↓
如果关闭摸鱼模式：
  - 设置窗口置顶（true）
  - 设置透明度（30%）
  - 发送事件到前端
  ↓
前端接收事件
  ↓
更新 store 状态
  ↓
应用 CSS 样式（背景模糊、透明）
  ↓
启用鼠标悬停监听
```

### 3. 搜索流程

```
用户输入搜索关键字
    ↓
用户点击"搜索"按钮
    ↓
前端调用 searchService.SearchInNovel()
    ↓
后端执行搜索算法
    ↓
返回搜索结果列表
    ↓
前端更新搜索结果
    ↓
渲染搜索结果列表
    ↓
用户点击某个搜索结果
    ↓
前端计算目标位置
    ↓
滚动到对应位置
    ↓
高亮显示关键字
```

### 4. 章节导航流程

```
用户在侧边栏点击章节
    ↓
前端调用 setCurrentChapter(index)
    ↓
更新 store 中的 currentChapter
    ↓
调用后端 GetChapterContent(index)
    ↓
后端根据章节索引提取内容
    ↓
返回章节内容
    ↓
前端更新阅读区域内容
    ↓
滚动到页面顶部
    ↓
保存阅读进度
```

---

## 数据存储

### 配置文件

**位置**: `config/config.{env}.json`

**内容**:
```json
{
  "environment": "local",
  "app_name": "Tfiction",
  "version": "1.0.0",
  "data_dir": "",
  "log_level": "info",
  "supported_formats": ["txt", "epub", "pdf", "mobi", "azw3"],
  "max_file_size": 100
}
```

### 用户数据

**位置**: `~/.tfiction/`

**目录结构**:
```
~/.tfiction/
├── progress.json          # 阅读进度
├── bookmarks.json         # 书签数据
├── settings.json          # 用户设置
└── recent.json            # 最近打开
```

### 阅读进度文件

**文件**: `progress.json`

**格式**:
```json
{
  "novels": [
    {
      "file_path": "/path/to/novel.txt",
      "current_chapter": 5,
      "position": 1234,
      "progress": 45.6,
      "last_read_time": 1700000000
    }
  ]
}
```

### 用户设置文件

**文件**: `settings.json`

**格式**:
```json
{
  "reading": {
    "font_size": 16,
    "font_family": "system-ui",
    "line_height": 1.8,
    "theme": "light",
    "background_color": "#ffffff",
    "text_color": "#333333",
    "page_width": 800
  },
  "window": {
    "width": 1200,
    "height": 800,
    "x": 100,
    "y": 100,
    "always_on_top": false
  }
}
```

---

## 未来规划

### Phase 1 - 基础功能完善（已完成）
- ✅ 项目框架搭建
- ✅ TXT 格式支持
- ✅ 基础阅读界面
- ✅ 章节导航
- ✅ 全文搜索
- ✅ 摸鱼模式
- ✅ 窗口置顶

### Phase 2 - 格式支持扩展（进行中）
- 🔄 EPUB 格式支持
- 🔄 PDF 格式支持
- 🔄 MOBI/AZW3 格式支持
- 🔄 格式转换功能
- 🔄 图片显示支持

### Phase 3 - 阅读体验优化
- ⏳ 分页阅读模式
- ⏳ 自动滚动模式
- ⏳ 语音朗读（TTS）
- ⏳ 夜间模式自动切换
- ⏳ 字体安装和管理
- ⏳ 快捷键自定义

### Phase 4 - 高级功能
- ⏳ 书签和标注
- ⏳ 阅读笔记
- ⏳ 内容导出
- ⏳ 云同步（可选）
- ⏳ 多语言支持
- ⏳ 插件系统

### Phase 5 - 社区功能（可选）
- ⏳ 书评系统
- ⏳ 阅读统计
- ⏳ 成就系统
- ⏳ 分享功能

---

## 技术债务和优化点

### 性能优化
1. **大文件处理**
   - 实现文件流式读取
   - 章节内容懒加载
   - 虚拟滚动优化

2. **内存优化**
   - 限制缓存小说数量
   - 实现 LRU 缓存策略
   - 及时释放不用的资源

3. **渲染优化**
   - React 组件 memo 优化
   - 使用 Web Worker 处理搜索
   - 图片懒加载

### 用户体验
1. **加载状态**
   - 添加加载动画
   - 进度条显示
   - 错误提示优化

2. **操作反馈**
   - 操作确认对话框
   - Toast 消息提示
   - 动画过渡效果

3. **无障碍支持**
   - 键盘导航优化
   - 屏幕阅读器支持
   - 高对比度模式

### 代码质量
1. **测试覆盖**
   - 单元测试
   - 集成测试
   - E2E 测试

2. **错误处理**
   - 统一错误处理机制
   - 错误日志记录
   - 崩溃恢复

3. **文档完善**
   - API 文档
   - 组件文档
   - 开发者指南

---

## 附录

### 支持的章节标题格式

```
第一章 xxx
第1章 xxx
第001章 xxx
Chapter 1
chapter 1
CHAPTER 1
1. xxx
01. xxx
【第一章】xxx
（第一章）xxx
一、xxx
```

### 快捷键列表（规划）

| 快捷键 | 功能 |
|--------|------|
| Ctrl + O | 打开文件 |
| Ctrl + F | 打开搜索 |
| Ctrl + Shift + S | 切换摸鱼模式 |
| Ctrl + + | 增大字号 |
| Ctrl + - | 减小字号 |
| Ctrl + 0 | 重置字号 |
| Ctrl + D | 添加书签 |
| F11 | 全屏 |
| ← / → | 上一章/下一章 |
| PageUp / PageDown | 上一页/下一页 |
| Home | 跳到开头 |
| End | 跳到结尾 |

### 系统要求详细说明

**Windows**
- 操作系统：Windows 10 (1809+) / Windows 11
- WebView2 Runtime（自动安装）
- 内存：最低 4GB RAM
- 磁盘：最低 100MB 可用空间

**macOS**
- 操作系统：macOS 10.15 (Catalina) 或更高
- 内存：最低 4GB RAM
- 磁盘：最低 100MB 可用空间

---

**文档版本**: v1.0.0
**最后更新**: 2024-11-27
**维护者**: NongChen
